# 依赖分析指南

> 深挖需求链，确保端到端完整性

## 为什么需要依赖分析？

**问题场景**：
```
用户: "添加用户登录功能"
AI: 直接开始设计登录页面...
结果: Design 阶段发现没有用户模型，没有 Session 管理，没有密码加密...
```

**正确做法**：
```
用户: "添加用户登录功能"
AI:
  1. 分析前置依赖: 用户模型? Session? 密码加密?
  2. 发现缺失: 用户模型不存在
  3. 添加到 Backlog: "用户模型基础设施"
  4. 继续分析下一个依赖...
  5. 所有依赖分析完成后，再进入 Design
```

## 依赖类型详解

### 1. 功能依赖 (Feature)

**定义**: 需要其他 Feature 的能力才能工作

**识别问题**：
- 这个功能需要调用什么其他功能？
- 有没有前置步骤需要先完成？
- 用户在使用这个功能前需要做什么？

**示例**：
| Feature | 功能依赖 |
|---------|----------|
| 订单创建 | 购物车、商品详情、用户认证 |
| 评论功能 | 用户认证、内容审核 |
| 导出报表 | 数据查询、文件生成 |

### 2. 数据依赖 (Data)

**定义**: 需要特定的数据结构/模型

**识别问题**：
- 这个功能需要存储什么数据？
- 数据结构是否已定义？
- 需要新建表/集合吗？

**示例**：
| Feature | 数据依赖 |
|---------|----------|
| 用户登录 | User 模型、Session 模型 |
| 订单管理 | Order 模型、OrderItem 模型 |
| 权限控制 | Role 模型、Permission 模型 |

### 3. 基础设施依赖 (Infra)

**定义**: 需要底层能力支持

**识别问题**：
- 需要什么底层服务？
- 需要什么工具/库？
- 需要什么运行时能力？

**示例**：
| Feature | 基础设施依赖 |
|---------|--------------|
| 文件上传 | 存储服务、文件处理库 |
| 邮件发送 | SMTP 配置、邮件模板 |
| 定时任务 | 调度器、任务队列 |

### 4. 外部依赖 (External)

**定义**: 需要外部服务/API

**识别问题**：
- 需要对接什么第三方服务？
- API 是否可用？
- 需要什么认证/配置？

**示例**：
| Feature | 外部依赖 |
|---------|----------|
| 支付功能 | 支付网关 API |
| 地图定位 | 地图服务 API |
| 短信验证 | 短信服务 API |

## 依赖分析流程

### 第一轮：广度分析

```
1. 列出功能的所有输入
   - 用户输入什么？
   - 系统需要什么数据？
   - 需要什么前置条件？

2. 列出功能的所有输出
   - 产生什么数据？
   - 触发什么后续动作？
   - 影响什么其他功能？

3. 列出功能的所有交互
   - 调用什么服务？
   - 访问什么存储？
   - 需要什么权限？
```

### 第二轮：深度分析

对第一轮识别的每个依赖项：

```
for each dependency:
    1. 检查是否已存在 (Grep docs/requirements/)
    2. 如果存在:
       - 记录依赖关系
       - 检查其状态是否 ready
       - ⭐ 加载依赖上下文 (见下文)
    3. 如果不存在:
       - 创建 Backlog 条目
       - 评估优先级
       - 递归分析这个新需求的依赖
```

### 第二轮半：加载依赖上下文 ⭐

**对于每个已存在的依赖 Feature，必须读取其完整文档并分析交互方式**。

#### 为什么需要加载依赖上下文？

```
❌ 错误做法:
Feature A requires: [feat-user-auth]
→ 只记录依赖 ID，不了解 feat-user-auth 的具体能力

✅ 正确做法:
Feature A requires: [feat-user-auth]
→ Read feat-user-auth.md
→ 了解: 提供 login(), logout(), isAuthenticated() 接口
→ 了解: 需要 JWT token，有效期 24h
→ 记录: A 将使用 isAuthenticated() 检查用户状态
```

#### 依赖上下文加载流程

```bash
# 1. 定位依赖文档
Glob "docs/requirements/**/<dep-feature-id>.md"

# 2. 读取完整内容
Read docs/requirements/<domain>/<dep-feature-id>.md

# 3. 解析关键信息
```

#### 从依赖文档中提取的信息

| 提取项 | 来源位置 | 用途 |
|--------|----------|------|
| **接口定义** | 需求描述 / AC | 确定如何调用 |
| **数据格式** | 技术约束 / AC | 确定输入输出 |
| **状态依赖** | 依赖分析 | 确定前置条件 |
| **约束限制** | 技术约束 | 避免误用 |
| **当前状态** | Frontmatter.status | 判断是否可用 |

#### 依赖交互分析模板

对每个依赖，在当前 Feature 文档中记录：

```markdown
### 2.5 依赖交互分析

#### 与 feat-user-auth 的交互

**依赖来源**: docs/requirements/CoreEngine/user-auth.md
**依赖状态**: implementing (进行中)

**提供的能力**:
- `login(credentials)`: 用户登录，返回 JWT token
- `logout()`: 清除会话
- `isAuthenticated()`: 检查当前用户是否已认证

**本 Feature 使用方式**:
- 在页面加载时调用 `isAuthenticated()` 检查登录状态
- 未登录时重定向到登录页

**数据契约**:
- 输入: `{ username: string, password: string }`
- 输出: `{ token: string, expiresIn: number }`

**约束与注意事项**:
- Token 有效期 24 小时，需处理过期情况
- 并发请求需要处理 401 响应

**对设计阶段的影响**:
- 需要设计 token 刷新机制
- 需要设计统一的认证拦截器
```

#### 依赖加载的递归边界

```
直接依赖 (深度 1): 必须加载
├─ feat-user-auth ← Read 完整文档

间接依赖 (深度 2): 选择性加载
├─ feat-user-auth.requires: [feat-database]
│  └─ 如果与当前 Feature 相关 → 加载
│  └─ 如果无直接关系 → 只记录存在

深层依赖 (深度 3+): 不加载
└─ 只记录依赖链，不展开分析
```

### 第三轮：影响分析

```
1. 这个 Feature 会改变什么现有接口？
2. 哪些现有功能需要适配？
3. 是否需要数据迁移？
4. 是否有破坏性变更？
```

## 依赖图示例

```
                    ┌─────────────────┐
                    │  用户登录功能    │
                    └────────┬────────┘
                             │
            ┌────────────────┼────────────────┐
            │                │                │
            ▼                ▼                ▼
    ┌───────────────┐ ┌───────────┐ ┌─────────────────┐
    │  用户模型      │ │ Session   │ │   密码加密      │
    │  (Data)       │ │ (Infra)   │ │   (Infra)       │
    └───────┬───────┘ └───────────┘ └─────────────────┘
            │
            ▼
    ┌───────────────┐
    │  数据库配置    │
    │  (Infra)      │
    └───────────────┘
```

## Backlog 优先级规则

| 优先级 | 条件 | 说明 |
|--------|------|------|
| **Critical** | 被 3+ 个 Feature 依赖 | 阻塞多个功能 |
| **High** | 基础设施类 | 底层能力，影响范围大 |
| **Medium** | 被 1-2 个 Feature 依赖 | 正常依赖 |
| **Low** | 可选增强 | 不阻塞核心功能 |

## R → D 阶段转换检查

**必须全部满足**：

- [ ] 当前 Feature 依赖分析完成
- [ ] 所有前置依赖已存在或已在 Backlog 中
- [ ] Backlog 中的关键依赖已分析完成
- [ ] 没有循环依赖
- [ ] 依赖链深度不超过 3 层（否则需要重新拆分）

**可选条件**：

- [ ] Backlog 完全为空（最严格）
- [ ] Backlog 中仅剩低优先级项目（可接受）
